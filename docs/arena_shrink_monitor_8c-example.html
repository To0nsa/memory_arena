<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>memory_arena: arena_shrink_monitor.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">memory_arena
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">arena_shrink_monitor.c</div></div>
</div><!--header-->
<div class="contents">
<p>Attempt to shrink the arena's buffer if underutilized.</p>
<p>Attempt to shrink the arena's buffer if underutilized.This function evaluates whether the current memory usage of the arena is significantly lower than its allocated size. If so, and if the arena allows dynamic resizing, it attempts to shrink the buffer to reduce memory footprint.</p>
<p>The shrink target is computed as the current used size plus a padding (<code>ARENA_SHRINK_PADDING</code>) to avoid immediate re-expansion.</p>
<p>Conditions for shrinking:</p><ul>
<li><code>arena != NULL</code></li>
<li><code>can_grow</code> is true</li>
<li>The usage ratio (<code>offset / size</code>) is below <code>ARENA_MIN_SHRINK_RATIO</code></li>
<li>The computed target size is smaller than the current buffer size</li>
</ul>
<p>This function is thread-safe and acquires the arena lock internally.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">arena</td><td>Pointer to the arena to check for shrinking opportunity.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>This is a non-destructive optimization. It has no effect if the arena does not support resizing, is already compact, or if shrinking would not release significant memory.</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="arena__resize_8c.html#ac09092abf5d001bd4ff11af16fed346d">arena_shrink</a> </dd>
<dd>
<a class="el" href="group__arena__resize__internal.html#gae22777b5f27566fdb53247d3b34423cc" title="Decide whether the arena buffer should be shrunk based on usage ratio.">arena_should_maybe_shrink</a> </dd>
<dd>
<a class="el" href="group__arena__resize__internal.html#ga11682f2046cdc92c45cc6ac544a0576b" title="Compute the target buffer size for a shrink operation.">arena_shrink_target</a></dd></dl>
<p>Example of running a background thread to monitor and shrink an arena.</p>
<p>This example creates a shared arena that is used for allocations, while a background thread periodically checks whether the arena should be shrunk using <code><a class="el" href="arena__resize_8c.html#a43195b93eadf7cbd1155836c887ac54d">arena_might_shrink()</a></code>.</p>
<p>This pattern is useful in applications that experience temporary spikes in memory usage but want to reclaim memory afterward without destroying the arena.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="arena_8h.html">arena.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;pthread.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdatomic.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> atomic_bool keep_running = <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span>* shrink_monitor_thread(<span class="keywordtype">void</span>* arg)</div>
<div class="line">{</div>
<div class="line">    <a id="_a0" name="_a0"></a><a class="code hl_struct" href="structt__arena.html">t_arena</a>* arena = (<a class="code hl_struct" href="structt__arena.html">t_arena</a>*) arg;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (atomic_load(&amp;keep_running))</div>
<div class="line">    {</div>
<div class="line">        <a id="a1" name="a1"></a><a class="code hl_function" href="arena_8h.html#a43195b93eadf7cbd1155836c887ac54d">arena_might_shrink</a>(arena);</div>
<div class="line">        sleep(1); <span class="comment">// Check every second</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_struct" href="structt__arena.html">t_arena</a>* arena = <a id="a2" name="a2"></a><a class="code hl_function" href="arena_8h.html#ad623b3dfc5761c29d44f78c58821c932">arena_create</a>(1024, <span class="keyword">true</span>); <span class="comment">// Growable arena</span></div>
<div class="line">    <span class="keywordflow">if</span> (!arena)</div>
<div class="line">    {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Failed to create arena.\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    pthread_t thread;</div>
<div class="line">    <span class="keywordflow">if</span> (pthread_create(&amp;thread, NULL, shrink_monitor_thread, arena) != 0)</div>
<div class="line">    {</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Failed to create shrink monitor thread.\n&quot;</span>);</div>
<div class="line">        <a id="a3" name="a3"></a><a class="code hl_function" href="arena_8h.html#a7821a62eaf6d9f982322e49eaf6153e8">arena_delete</a>(&amp;arena);</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Simulate allocations and deallocations</span></div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; 10; ++i)</div>
<div class="line">    {</div>
<div class="line">        <a id="a4" name="a4"></a><a class="code hl_function" href="arena_8h.html#a1def00c6156e8df19f0a1af7cd6f26dd">arena_alloc</a>(arena, 1024 * 32); <span class="comment">// allocate 32 KB</span></div>
<div class="line">        usleep(200 * 1000);            <span class="comment">// wait 200ms</span></div>
<div class="line">        <a id="a5" name="a5"></a><a class="code hl_function" href="arena_8h.html#a1a2582ca5fb4e571ac150fbd77bd0d82">arena_reset</a>(arena);            <span class="comment">// simulate freeing all</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Stop background thread</span></div>
<div class="line">    atomic_store(&amp;keep_running, <span class="keyword">false</span>);</div>
<div class="line">    pthread_join(thread, NULL);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_function" href="arena_8h.html#a7821a62eaf6d9f982322e49eaf6153e8">arena_delete</a>(&amp;arena);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aarena_8h_html"><div class="ttname"><a href="arena_8h.html">arena.h</a></div><div class="ttdoc">Core public API for the Arena memory allocator.</div></div>
<div class="ttc" id="aarena_8h_html_a1a2582ca5fb4e571ac150fbd77bd0d82"><div class="ttname"><a href="arena_8h.html#a1a2582ca5fb4e571ac150fbd77bd0d82">arena_reset</a></div><div class="ttdeci">void arena_reset(t_arena *arena)</div><div class="ttdef"><b>Definition</b> arena_state.c:345</div></div>
<div class="ttc" id="aarena_8h_html_a1def00c6156e8df19f0a1af7cd6f26dd"><div class="ttname"><a href="arena_8h.html#a1def00c6156e8df19f0a1af7cd6f26dd">arena_alloc</a></div><div class="ttdeci">void * arena_alloc(t_arena *arena, size_t size)</div><div class="ttdef"><b>Definition</b> arena_alloc.c:112</div></div>
<div class="ttc" id="aarena_8h_html_a43195b93eadf7cbd1155836c887ac54d"><div class="ttname"><a href="arena_8h.html#a43195b93eadf7cbd1155836c887ac54d">arena_might_shrink</a></div><div class="ttdeci">bool arena_might_shrink(t_arena *arena)</div><div class="ttdef"><b>Definition</b> arena_resize.c:385</div></div>
<div class="ttc" id="aarena_8h_html_a7821a62eaf6d9f982322e49eaf6153e8"><div class="ttname"><a href="arena_8h.html#a7821a62eaf6d9f982322e49eaf6153e8">arena_delete</a></div><div class="ttdeci">void arena_delete(t_arena **arena)</div><div class="ttdef"><b>Definition</b> arena_cleanup.c:148</div></div>
<div class="ttc" id="aarena_8h_html_ad623b3dfc5761c29d44f78c58821c932"><div class="ttname"><a href="arena_8h.html#ad623b3dfc5761c29d44f78c58821c932">arena_create</a></div><div class="ttdeci">t_arena * arena_create(size_t size, bool allow_grow)</div><div class="ttdef"><b>Definition</b> arena_create.c:111</div></div>
<div class="ttc" id="astructt__arena_html"><div class="ttname"><a href="structt__arena.html">t_arena</a></div><div class="ttdoc">The main memory arena structure used for fast allocation.</div></div>
</div><!-- fragment --><div class="fragment"></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
